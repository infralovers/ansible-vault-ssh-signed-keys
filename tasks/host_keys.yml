---

- name: load actual public host key
  set_fact:
    ssh_public_key: "{{ lookup('file', '/etc/ssh/{{ sshd_certfile }}.pub') }}"

- name: generate signed host key
  register: signed_host_key
  delegate_to: localhost
  become: false
  community.hashi_vault.vault_write:
    path: "{{ host_ssh_path }}/sign/{{ host_ssh_role }}"
    data:
      cert_type: host
      public_key: "{{ ssh_public_key }}"

- name: update signed host key certificate
  copy:
    content: "{{ signed_host_key.data.signed_key }}"
    dest: "/etc/ssh/{{ sshd_certfile }}_signed.pub"
    mode: "0640"
    owner: root
    group: root
  notify:
    - restart sshd

- name: ensure ssh config with enabled host key
  lineinfile:
    regexp: "^HostKey"
    line: "HostKey /etc/ssh/{{ sshd_certfile }}"
    dest: /etc/ssh/sshd_config
    mode: 0640
  notify:
    - restart sshd

- name: update ssh config with signed host certificate from vault
  lineinfile:
    regexp: "^HostCertificate"
    line: "HostCertificate /etc/ssh/{{ sshd_certfile }}_signed.pub"
    dest: /etc/ssh/sshd_config
    mode: 0640
  notify:
    - restart sshd

- name: load trusted ca from vault
  register: vault_trusted_keys
  delegate_to: localhost
  become: false
  community.hashi_vault.vault_read:
    path: "{{ host_ssh_path }}/config/ca"
  
- name: add trust authority configuration
  become: false
  lineinfile:
    dest: ~/.ssh/known_hosts
    regexp: "^@cert-authority *"
    line: "@cert-authority * {{ vault_trusted_keys.data.public_key }}"
